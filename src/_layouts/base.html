---
criticalCSS:
  - css/fontFace.liquid
  - css/fontVariables.liquid
---
{%- comment -%}Global variables for reuse in meta tags{%- endcomment -%}
{%- if page.url == "/" -%}
  {%- assign pageTitle = site.title -%}
{%- else -%}
  {%- assign pageTitle = title | default: renderData.title -%}
  {%- assign pageTitle = pageTitle | append: " | " | append: site.title -%}
{%- endif -%}
{%- assign description = description | default: site.description -%}
{%- assign keywords = keywords | default: site.keywords -%}
{%- comment -%}Canonical URL. Make sure each page has one since some spam sites pull and repost content.{%- endcomment -%}
{%- assign defaultCanonicalUrl = page.url | toAbsoluteUrl -%}
{%- assign canonicalUrl = canonicalUrl | default: defaultCanonicalUrl -%}
<!DOCTYPE html>
<html lang="{{ site.lang }}">
<head>
  <meta charset="utf-8">
  {%- comment -%}Metadata for search engines{%- endcomment -%}
  <title>{{ pageTitle }}</title>
  <meta name="description" content="{{ description }}">
  <meta name="keywords" content="{{ keywords | join: ', ' }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="{{ site.author }}">
  <link rel="canonical" href="{{ canonicalUrl }}">
  {%- comment -%}Prevent this page from showing up on search engines{%- endcomment -%}
  {%- if noindex -%}
    <meta name="robots" content="noindex">
  {%- endif -%}
  {%- comment -%}Critical CSS goes in head{%- endcomment -%}
  {%- if criticalCSS -%}
      {%- capture critical -%}
        {%- for partial in criticalCSS -%}
          {%- include partial -%}
        {%- endfor -%}
      {%- endcapture -%}
      <style>{{ critical | cleanCSS }}</style>
  {%- endif -%}
  {%- comment -%}Global and page/layout-specific CSS{%- endcomment -%}
  {%- for href in stylesheets -%}
    <link rel="stylesheet" href="{{ href }}">
  {%- endfor -%}
  {%- comment -%}Favicons{%- endcomment -%}
  {% favicon 'src/assets/images/favicons/favicon.png' %}
  {%- comment -%}Load the user's last selected theme{%- endcomment -%}
  {%- if isThemed -%}
    <script>
      (function() {
        // Enum of supported themes. Not strictly needed; just helps avoid typos and magic strings.
        const Theme = {
          LIGHT: 'light',
          DARK: 'dark',
        };
        // We'll use this to write and read to localStorage and save the theme as a data- attribute
        const THEME_STORAGE_KEY = 'theme';
        // :root will own the data- attribute for the current theme override
        const themeOwner = document.documentElement;

        // Check to see if the user previously set a site theme preference. If they did, toggle data attribute immediately to prevent theme flash.
        const cachedTheme = localStorage.getItem(THEME_STORAGE_KEY);
        // This should never be false, but it could be if a user tampers with localStorage directly
        const isValidCachedTheme = !!cachedTheme && new Set(Object.values(Theme)).has(cachedTheme);
        if (isValidCachedTheme) {
          themeOwner.dataset[THEME_STORAGE_KEY] = cachedTheme;
        } else {
          localStorage.removeItem(THEME_STORAGE_KEY);
        }

        // Run this only after DOM parsing so we can grab refs to elements. Putting this code here so it's co-located with the above logic.
        document.addEventListener('DOMContentLoaded', () => {
          const themeToggle = document.getElementById('theme-toggle');
          if (!themeToggle) return;

          /* System preference (not app preference). We'll use this to listen for system preference changes so we can sync the button aria-pressed
          state. This will only be used in the case where a user never set an app preference (by clicking the toggle); we'll stop listening as soon
          as they do. Only checking dark mode to mirror CSS (where we assume light is default and override it with media queries). */
          const darkThemePreference = window.matchMedia('(prefers-color-scheme: dark)');

          /** Updates UI to reflect the given theme override. */
          const setTheme = (theme) => {
            themeOwner.dataset[THEME_STORAGE_KEY] = theme;
            themeToggle.setAttribute('aria-pressed', theme === Theme.DARK);
          }

          /** Called when a user clicks the theme toggle. Updates UI to reflect the new theme and persists the preference in storage. */
          const toggleTheme = () => {
            const currentTheme = themeOwner.dataset[THEME_STORAGE_KEY];
            const newTheme = currentTheme === Theme.LIGHT ? Theme.DARK : Theme.LIGHT;
            setTheme(newTheme);
            localStorage.setItem(THEME_STORAGE_KEY, newTheme);
            // As soon as the user opts into a site preference, stop listening to system preference
            darkThemePreference.removeEventListener?.('change', handleSystemThemePreferenceChange);
          }

          /** Given a user's system theme preference (from matchMedia API), updates theme state. */
          const handleSystemThemePreferenceChange = ({ matches: isDarkThemePreferred }) => {
            setTheme(isDarkThemePreferred ? Theme.DARK : Theme.LIGHT);
          };

          const initializeTheme = () => {
            // If user previously expressed preference by toggling the button, sync UI
            if (cachedTheme && isValidCachedTheme) {
              // Partially overlaps with initial logic, but that's okay. We mainly care about the button pressed state (now that DOM has loaded).
              setTheme(cachedTheme);
            } else {
              /* User never chose a theme, so fall back to system preference. Watch for changes and sync UI.
              This is for the rare edge case where a user changes preference while on my site. Note: Using optional chaining since
              addEventListener is only available on Safari 14+. */
              darkThemePreference.addEventListener?.('change', handleSystemThemePreferenceChange);
              // Call manually once to sync initial state on load
              handleSystemThemePreferenceChange(darkThemePreference);
            }
          };

          initializeTheme();
          themeToggle.addEventListener('click', toggleTheme);
        });
      })();
    </script>
  {%- endif -%}
  {%- comment -%}Template-specific module scripts{%- endcomment -%}
  {%- for script in scripts -%}
    <script src="{{ script.src }}"{% if script.defer %} defer{% endif %}{% if script.type %} type="{{ script.type }}"{% endif %}></script>
  {%- endfor -%}
  {%- comment -%}Open Graph social media previews{%- endcomment -%}
  <meta property="og:title" content="{{ pageTitle }}">
  {%- if openGraph.image -%}
    <meta property="og:image" content="{{ openGraph.image }}">
  {%- endif -%}
  <meta property="og:description" content="{{ description }}">
  <meta property="og:url" content="{{ page.url | toAbsoluteUrl }}">
  <meta property="og:type" content="{{ openGraph.type | default: "website" }}">
  <meta property="og:locale" content="{{ site.lang | replace: "-", "_" }}">
  {%- comment -%}Twitter card meta tags{%- endcomment -%}
  <meta name="twitter:card" content="{{ openGraph.twitter.card | default: "summary" }}">
  <meta name="twitter:creator" content="{{ "@" | append: socials.twitter.username }}">
  <meta name="twitter:title" content="{{ openGraph.title | default: pageTitle }}">
  <meta name="twitter:description" content="{{ openGraph.description | default: description }}">
  {%- if openGraph.image -%}
    <meta name="twitter:image" content="{{ openGraph.image }}">
  {%- endif -%}
  {%- comment -%}Preload optimizations{%- endcomment -%}
  {%- if preloads -%}
    {% for preload in preloads %}
      <link rel="{{ preload.rel | default: "preload" }}" as="{{ preload.as }}" type="{{ preload.type }}" href="{{ preload.href }}" {% if preload.crossorigin %}crossorigin{% endif %}>
    {%- endfor -%}
  {% endif %}
  {%- comment -%}RSS{%- endcomment -%}
  <link rel="alternate" type="application/rss+xml" title="RSS Feed for aleksandrhovhannisyan.com" href="/feed.xml">
  {%- comment -%}No-JS styles{%- endcomment -%}
  <noscript><style>{% if isThemed %}#theme-toggle,{% endif %}.youtube-embed{display:none;}</style></noscript>
  {%- comment -%}Framework that generated the site{%- endcomment -%}
  <meta name="generator" content="{{ eleventy.generator }}">
  {%- comment -%}Design mode. Only in a dev environment, and only if enabled in environment variables.{%- endcomment -%}
  {%- if featureFlags.enableDesignMode -%}
    <script>
      (function() {
        const DESIGN_MODE_STORAGE_KEY = 'design-mode';
        const cachedDesignMode = localStorage.getItem(DESIGN_MODE_STORAGE_KEY);
        document.designMode = cachedDesignMode;

        document.addEventListener('keyup', (e) => {
          if (e.ctrlKey && e.key === '.') {
            const newDesignMode = document.designMode === 'on' ? 'off' : 'on';
            document.designMode = newDesignMode;
            localStorage.setItem(DESIGN_MODE_STORAGE_KEY, newDesignMode);
          }
        });
      })();
    </script>
  {%- endif -%}
</head>
<body>
  {{ content }}
</body>
</html>

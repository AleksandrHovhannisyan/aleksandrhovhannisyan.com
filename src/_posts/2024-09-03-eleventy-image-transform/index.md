---
title: Eleventy Images Just Got Better
description: Eleventy 3.0 adds a new API to optimize images anywhere on your site, without shortcodes.
keywords: [eleventy, eleventy image, 11ty]
categories: [11ty, images, webperf]
thumbnail: ./images/eleventy-conference.png
---

A few years ago, I wrote an in-depth guide on how to [optimize images in Eleventy](/blog/eleventy-image-plugin/) with the official image plugin. All you need is an async function that takes an image source and some metadata and feeds it to the Eleventy image plugin to generate HTML. You can then use this function as a shortcode in any template, with this syntax:

{% raw %}

```liquid
{% image 'source', 'alt', etc. %}
```

{% endraw %}

This worked well for a while, but I was never a fan of embedding so much foreign syntax into my Markdown posts. The more I relied on this syntax, the more dependent I would become on it, making it difficult for me to ever migrate to a different static site generator in the future. This awkward syntax also slowed me down because of the lack of path auto-completion and image previews, which I partly blame for the steady decline in the number of images on my blog (or maybe I just got better at explaining things with words).

What I really wanted was to be able to embed Markdown images normally, like you can in Gatsby and other frameworks, while still optimizing them:

```md
![alt](/path/to/image.jpeg)
```

Even better, I wanted to be able to co-locate my images with my posts:

```md
![alt](./images/image.jpeg)
```

This was a feature that other developers wanted, too:

{% quote "Sara Soueidan on X", "https://x.com/SaraSoueidan/status/1533468684089536513" %}
Hey @eleven_ty folks,

On my new site, I want to place images in the same directory as the article/page they are used in. What plugin is everyone using to do that? Thx!

(Also, no pressure but when are we getting that feature built into 11ty @zachleat ðŸ™ˆ)
{% endquote %}

In fact, this feature request was so popular that Zach Leatherman opened an issue for it in the Eleventy repo: [Co-locating images together with a blog post in a folder](https://github.com/11ty/eleventy/issues/2428).

I managed to solve the co-location problem on my blog with a bit of Node.js path manipulation, but using the native Markdown syntax proved to be more challenging.

## Prior Art

Early on, other folks had ideas on how to use the Eleventy image plugin without shortcodes. Some of them even shared prototypes or published plugins that I'm sure helped pave the way for the topic of this article. Let's look at some of those early solutions.

### Ben Holmes: `addExtension`

As far back as in 2021, Ben Holmes put together an [11ty image optimization demo](https://github.com/bholmesdev/11ty-image-optimization-demo) where he used Eleventy's [`addExtension` API](https://www.11ty.dev/docs/languages/custom/) to add custom processing to Markdown files. The code rendered Markdown files to HTML, queried all image nodes in the DOM, and replaced them with the output generated by the Eleventy image plugin:

```js
eleventyConfig.addExtension('md', {
  read: true,
  compile() {
    return async function render(data) {
      const html = await this.defaultRenderer(data);
      const $ = cheerio.load(html);

      if (data.tags?.includes('blog')) {
        await Promise.all(
          // loop over all the images in our document
          $('img')
            .toArray()
            .map(async (img) => {
              // grab the image attributes
              const { src = '', alt = '', sizes = '100vw' } = img.attribs;
              // convert to an optimized image
              const optimizedImage = await imageShortcode(src, alt, sizes);
              // replace our images with an optimized one
              $(img).replaceWith(optimizedImage);
            })
        );
      }

      return $.html();
    };
  },
});
```

At some point, [I created a PR to use this on my site](https://x.com/hovhaDovah/status/1525086605303857152), but I quickly hit a roadblock with the `addExtension` API that was [noted by Deborah Barnard](https://deborahwrites.com/blog/markdoc-eleventy/#enabling-markdoc) in another article:

{% quote "Using Markdoc with Eleventy: a quick test", "https://deborahwrites.com/blog/markdoc-eleventy/#gotchas" %}
Overriding the default Markdown parser opts-out of pre-processing your Markdown files with any other parser. Normally, with Eleventy, you can choose a templating language and pre-process your Markdown files. For example, setting `markdownTemplateEngine: "njk"` in your config file allows you to use Nunjucks in your Markdown. By default, Eleventy uses Liquid for pre-processing. Enabling Markdoc prevents this step, but (slightly confusingly) the command line output still says it's using Liquid. To avoid confusion, set `markdownTemplateEngine: false`. Keep in mind that this removes the ability to use custom Eleventy shortcodes and filters: you'll have to rely on Markdoc tags, functions, and node customization.
{% endquote %}

So while I was actually able to use Ben's solution to automatically optimize all of my Markdown images, I could no longer use Liquid tags or even custom Eleventy shortcodes and front-matter variables. Unfortunately, this was a tradeoff that I couldn't afford, as I rely heavily on custom shortcodes on my site.

### Mathieu: `markdown-it-eleventy-img`

In 2022, GitHub user solution-loisir published [`markdown-it-eleventy-img`](https://github.com/solution-loisir/markdown-it-eleventy-img), for use with the popular [`markdown-it`](https://github.com/markdown-it/markdown-it) library. Here's an example from that plugin's README:

```js
markdownIt()
.use(markdownItEleventyImg, {
  imgOptions: {
    widths: [800, 500, 300],
    urlPath: "/images/",
    outputDir: path.join("_site", "images"),
    formats: ["avif", "webp", "jpeg"]
  },
  globalAttributes: {
    class: "markdown-image",
    decoding: "async",
    // If you use multiple widths,
    // don't forget to add a `sizes` attribute.
    sizes: "100vw"
  },
});
```

Under the hood, the plugin uses `markdown-it`'s abstract syntax tree (AST) visitor to find all image nodes and process them with `eleventy-img`. For maximum control, the `renderImage` prop even allows you to render custom markup for these images.

Out of all the other solutions I had considered up until this point, this came closest to what I wanted to do on my site. But it had [two notable limitations](https://github.com/solution-loisir/markdown-it-eleventy-img?tab=readme-ov-file#limitations) that I couldn't work around:

- It can't be used with remote image sources.
- Due to a limitation with `markdown-it`, images can't be replaced asynchronously.

In the meantime, I decided to continue using partials and shortcodes.

## Eleventy Image Transform

In May 2024, Eleventy held its first international conference online, during which Zach Leatherman gave a talk on [The Future of 11ty](https://www.youtube.com/watch?v=tXNsWsEE7S0&list=PLwhCq3ZFGOGgetCSWisU2pkl9AFwQVxWJ&index=2) as a project. One of the things he unveiled during this presentation was an upcoming enhancement for the Eleventy image plugin: a new solution for optimizing Markdown images.

![11ty international symposium on making web sites real good. Speaker Zach Leatherman on the bottom-left. Main content shows a white slide with two big lines of text with strikethroughs: shortcodes and async vs. sync. This hints at the replacement of those old APIs with something new and better.](./images/eleventy-conference.png)

This plugin would be available for use in `@11ty/eleventy-img@4.0.1`, with additional enhancements coming in the 5.0 beta release (now available).

### Configuration API

You register the image transform plugin as you normally would and specify the options you want to use. Here's what I do on my site:

```js
import { eleventyImageTransformPlugin } from '@11ty/eleventy-img';

eleventyConfig.addPlugin(eleventyImageTransformPlugin, {
    // which file extensions to process
    extensions: 'html',
    // optional, output image formats
    formats: ['jpg', 'webp'],
    // optional, output image widths
    widths: ['auto', 400, 800],
    // optional, attributes assigned on <img> override these values.
    defaultAttributes: {
        loading: 'lazy',
        sizes: '100vw',
        decoding: 'async',
    },
});
```

With this specific configuration, Eleventy will process all `*.html` files and:

- Find each image tag.
- Generate output files for `jpeg` and `webp` images from each image source file.
- Create resized variants of those formats at `400px`, `800px`, and the original width (`auto`).
- Set `loading="lazy"`, `decoding="async"`, and `sizes="100vw"` on the image tags.

These options are specific to my use case, so you're of course free to change them.

### Custom Image Attributes

By default, all images are optimized. This is normally desired, but if you want to ignore certain image tags, you can give them an `eleventy:ignore` HTML attribute; Eleventy will remove that attribute but avoid optimizing the image. Consult [the plugin's documentation](https://www.11ty.dev/docs/plugins/image/#eleventy-transform) for more supported attributes.

Best of all, since the transform plugin only processes whatever files you tell it to (in this case, HTML), it doesn't interfere with any Markdown plugins you may have. For example, I use [`markdown-it-attrs`](https://www.npmjs.com/package/markdown-it-attrs) on my site, which allows me to give any Markdown element HTML attributes using curly braces:

```md
This is a paragraph with a class name. {.class}

![alt](./images/image.png){#id}
```

Importantly, any HTML attributes you set on individual images will take precedence over the global configuration. For example, if you have an image above the fold, you may want to avoid lazily loading that image (as doing so could potentially hurt your [largest contentful paint](https://web.dev/articles/lcp) score):

```md
![alt](./images/image.png){loading="eager"}
```

Alternatively, you may want to use different widths or formats for an image. You can do that using the special `eleventy:`-prefixed attributes (again, these will be removed):

```md
![alt](./images/image.png){eleventy:formats="auto,avif" eleventy:widths="900,1200"}
```

### Faster Local Builds

The transform API was originally introduced in `@11ty/eleventy-img@4.0.1`, and this version had one major performance bottleneck that I ran into during my initial testing: Local builds were anywhere from five to ten times slower than before. On my machine, that was the difference between cold starts of just 15 seconds on average and builds ranging from 70 to 100 seconds. Yikes!

Thankfully, it turned out this was my fault for not reading the documentation carefully. If you install the `5.0.0` branch (currently in beta as I'm writing this), it only processes images in `--serve` mode when they're requested by the browser, as opposed to optimizing every single image on startup. After the upgrade, my server starts up even more quickly than before because now it only optimizes images on demand.

## Migration Strategy

Before we wrap things up, I want to briefly document my strategy for migrating the thousands of images on my site to use this new plugin.

### 1. Installation

First, I upgraded `@11ty/eleventy-img`, registered the transform plugin, and updated my custom image shortcode to temporarily add the `eleventy:ignore` attribute. Sure, I planned to delete the shortcode eventually, but in the short term, this at least allowed me to register the plugin and play around with it on a few test pages. Otherwise, I'd potentially have to sink hours into the other migration steps before I could observe the plugin's output.

### 2. 301 Redirects

Many of my older blog posts rank highly in search results and have images that show up in Google Search. I knew that a migration like this would de-index all of the old images, potentially hurting my ranking for certain queries, so I didn't want to just rush this out.

Thankfully, I host my site on Cloudflare (previously Netlify), which allows you to define 301 redirects in a flat `_redirects` file like this:

```
/old/url /new/url
```

Creating these rules by hand would've been a nightmare since I had thousands of images, and there was no way to take advantage of `:splat` patterns to redirect the old images in bulk for my specific scenario.

Instead, I came up with what I think is a pretty clever solution: I updated my existing image shortcode to `console.log` the current output image path, followed by what I knew the path would _eventually_ be once I migrated to the new transform API. All my post images were referenced in one of two ways:

- Remote images: `https://example.com/image.jpeg`
- Local images: `./images/image.jpeg`

In either case, the output images were always written to a single image folder in bulk: `/assets/images`. Since my image shortcode already had access to the data cascade for whichever page called it, all I had to do was join `this.page.url` with the generated image's file name and that would be the new location. The following code is a greatly simplified view of what I did:

```js
export async function imageShortcode(props) {
    const data = Image(src, options);
    const newUrl = path.join(this.page.url, outputImageFileName);
    console.log(oldUrl, newUrl);
    return oldUrl;
}
```

Then, I ran the local dev server and copy-pasted the output into my `_redirects` file.

### 3. Regex Replacements

The trickiest part of the migration was replacing all of the old shortcodes/includes with the new Markdown image syntax. Thankfully, all of my post images used just one or two partials with predictable patterns:

{% raw %}
```liquid
{% include "postImage.html", src: "./images/path", alt: "", otherProps %}
```
{% endraw %}

Taking advantage of this, I did a global search-and-replace with regex in VS Code. There were a few different patterns I had to match, but it didn't take a whole lot of effort to handle outliers. Whenever you're doing regex replacements, it's always useful to start with more restricted patterns and work your way up to longer patterns.

{% raw %}
```plaintext
Find: \{% include "postImage\.html", src: "(.*?)", alt: "(.*?)" %\}
Replace: ![$2]($1)
```
{% endraw %}

For figures with captions, I just rendered those as plain old HTML (since Markdown allows HTML), and the images still got processed by the plugin.

## Summary

And that about does it! I was so relieved when I was finally able to delete all my old image shortcodes and [merged my PR](https://github.com/AleksandrHovhannisyan/aleksandrhovhannisyan.com/commit/ea54ef7219dc115a999af7837c2c5242a5c71d42). Now, my Markdown content is much simpler, and my build times have actually improved. I highly recommend migrating to this new API!